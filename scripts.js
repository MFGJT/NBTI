raw_prompt = 'In social events, you find yourself|At parties, you|At parties, you|You usually|You find that interaction in a large group of people is|With a large group of people, you are usually the person who|You tend to spend a lot of free time|When you are with a large group of people, you usually prefer to|With new people around you, you are|It generally takes people you have just met|People that you have met for a short time can|Most people you have known would say that you are|In social situations you frequently find it|You can keep a conversation going for a long time with|You can|As an instructor, you would prefer to teach|You generally prefer courses that focus on|You find it easier to be around|You would rather have a friend who|You are more attracted to a person who|You would rather be considered|When doing something that has been done many times before, you would prefer to|When looking at an established system, you would prefer to|In reading for pleasure, you enjoy|You more often let|You are more willing to|It is a higher compliment to be recognized as|It is more satisfying to have someone comment you as|You prefer to work with a director who is|In making important decisions, you favor arguments involving|If you are going somewhere for the day, you would prefer to|Before event season, you like to|In planning an upcoming trip, you would prefer to|You generally prefer to|You prefer to do things according to|When given a special job, you would prefer to|Under most circumstances, you would prefer to|Under most circumstances, you are more likely to|In doing daily chores, you|You prefer to comlete assigned tasks|Following a set schedule|You find that going by a schedule is|The idea of making a to-do list for the weekend sounds|When you begin working on a big project with an approaching deadline, you|When working on a big assignment, you tend to|You consider yourself|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|You feel more connected to the word|Given very limited time, you would choose to';
raw_option = 'conversing easily with others|being quiet and reserved|enjoy the atmosphere and have fun most of the time|sometimes get distracted and sit by yourself|do much of the talking|let others do most of the talking|blend in well with groups of people|tend to keep to yourself in social situations|energy-giving|energy-draining|introduce other people|get introduced to new people|with others|by yourself|join in the discussion with everyone else|talk in private to people that you know well|easy to get to know|hard to get to know|a little time to get to know you|a lot of time to get to know you|tell your interests immediately|know your interests only after a long time|an open person|a private person|easy to have long conversations with most people|hard to initiate conversations and keep them going|almost everyone|people who share you interests|start a conversation with anyone for a long time|have long conversations only in certain situations|novel concepts and ideas|established theories and facts|ideas and concepts|practice and figures|people who are imaginative|people who are realistic|consistently comes up with new ideas|always has a pragmatic point of view|has a quick and brilliant mind|has a lot of common sense|an ingenious person|a practical person|do it in a new way|do it in a common way|analyze and attack unsolved problems|support current methods of doing good|innovative or original expressions|straightforward and clear phrasing|your feelings rule your mind|your mind rule your feelings|value sentiment over logic|value logic over sentiment|a person of pure and honest feelings|a person with consistent flow of logic and reasoning|compassionate|competent|kind but not necessarily analytic|rational but not necessarily compassionate|opinions and subjective statements|figures and objective statements|just go|plan beforehand|leave an open schedule to do whatever seems fun|arrange times and dates in advance|have time to do whatever you feel like then|have a schedule of what you will be doing|have free time for things that catch your eyes|make plans of what you would do for each day|your feelings at the moment|previously made plans|discover different aspects while doing the job|organize before beginning to work on the job|improvise along the way|follow a routine or schedule|wait and observe and then make plans|have plans ready in advance|enjoy handling emergencies with time pressure|do what you can to avoid time pressure|on the spur-of-the-moment|according to plans|negatively impacts your work|contribute positively to your efforts|sometimes necessary but not ideal|enjoyable and helpful for most situations|repelling|attractive|jump into action|spend time planning|figure out the necessities as you go down the road|start by taking the assignment apart and analyzing it|spontaneous|organized|open|private|cheery|quiet|outgoing|remote|conversational|reserved|social|reclusive|gregarious|independent|abstract|solid|opinions|facts|possibility|certainty|proposal|statement|fantasy|actuality|theoretical|concrete|what-if|matter-of-fact|invent|build|design|produce|heuristic|sensible|imaginative|realistic|novelty|establishment|argument|evidence|prototype|make|fresh|studied|conceptual|physical|innovative|practical|gentle|firm|feeling|thinking|sensitive|just|touching|convincing|compassion|foresight|blessings|benefits|warm|objective|passionate|candid|softhearted|logical|sentimental|analytical|generous|sturdy|caring|impartial|tenderness|strength|emotional|practical|sympathize|anatomize|tender|strong-willed|devoted|determined|kind|competent|casual|expected|impulse|decision|autonomous|systematic|unconstrained|orderly|easygoing|disciplined|spontaneous|prepared|spend all time on にじげん|spend time with close friends';
raw_result = 'XNXNXNXNXNXNXNXNXNXNXNXNXNXNXNTBTBTBTBTBTBTBTBTBMRMRMRMRMRMRSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCXNXNXNXNXNXNTBTBTBTBTBTBTBTBTBTBTBTBTBTBTBTBTBMRMRMRMRMRMRMRMRMRMRMRMRMRMRMRMRMRMRSCSCSCSCSCSCAZ';
// raw_prompt = 'What do you see|What do you hear|What do you say';
// raw_option = 'monkeys|zebras|music|mumbling|nothing|everything';
// raw_result = 'XNXNXN'
// raw_prompt = 'In social events, you find yourself|At parties, you|At parties, you|You usually|You find that interaction in a large group of people is|With a large group of people, you are usually the person who|You tend to spend a lot of free time|When you are with a large group of people, you usually prefer to|With new people around you, you are|It generally takes people you have just met|People that you have met for a short time can|Most people you have known would say that you are|In social situations you frequently find it|You can keep a conversation going for a long time with|You can|As an instructor, you would prefer to teach|You generally prefer courses that focus on|You find it easier to be around|You would rather have a friend who|You are more attracted to a person who|You would rather be considered|When doing something that has been done many times before, you would prefer to|When looking at an established system, you would prefer to|In reading for pleasure, you enjoy|You more often let|You are more willing to|It is a higher compliment to be recognized as|It is more satisfying to have someone comment you as|You prefer to work with a director who is|In making important decisions, you favor arguments involving|If you are going somewhere for the day, you would prefer to|Before event season, you like to|In planning an upcoming trip, you would prefer to|You generally prefer to|You prefer to do things according to|When given a special job, you would prefer to|Under most circumstances, you would prefer to|Under most circumstances, you are more likely to|In doing daily chores, you|You prefer to comlete assigned tasks|Following a set schedule|You find that going by a schedule is|The idea of making a to-do list for the weekend sounds|When you begin working on a big project with an approaching deadline, you|When working on a big assignment, you tend to|You consider yourself';
prompts = raw_prompt.split('|');
options = raw_option.split('|');
results = raw_result.split('');
answers = 0;
XN_scores = [];
TB_scores = [];
MR_scores = [];
SC_scores = [];
XN_mean = 0;
TB_mean = 0;
MR_mean = 0;
SC_mean = 0;
XN_prob = 0;
TB_prob = 0;
MR_prob = 0;
SC_prob = 0;
const significant = 0.65;

prompt_order = Array.from(Array(prompts.length).keys());
prompt_order = shuffle(prompt_order); // order of questions
prompt_offset = []; // order of options
for (var i = 0; i < prompts.length; i++) {
    if (Math.random() < 0.5) {
        prompt_offset.push(0);
    } else {
        prompt_offset.push(1);
    }
}

console.log('Credits: IC U ACT Dept., Hoyii (IC U), Manyi (Mianjie Pav.)')

function shuffle(array) {
    let currentIndex = array.length, randomIndex;

    // While there remain elements to shuffle.
    while (currentIndex != 0) {

        // Pick a remaining element.
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;

        // And swap it with the current element.
        [array[currentIndex], array[randomIndex]] = [
            array[randomIndex], array[currentIndex]];
    }

    return array;
}

var selectStar = function () {
    var score = this.getAttribute("data-score");
    var stars = this.parentElement.getElementsByClassName('q-star');

    for (var i = 0; i < stars.length; i++) {
        if (stars[i].getAttribute("data-score") === score) {
            stars[i].innerHTML = '★';
            stars[i].style.color = 'transparent';
        } else {
            stars[i].innerHTML = '☆';
            stars[i].style.color = 'black';
        }
    }

    if (this.parentElement.parentElement.dataset.chosen === 'n') {
        answers = answers + 1;
        if (answers === prompts.length) {
            var submit = document.getElementById('submit-btn');
            submit.style.fontWeight = 'bold';
            submit.style.animation = 'rainbow-colors 2s infinite';
        }
    }
    this.parentElement.parentElement.dataset.chosen = score;
};

function appendStar(body, score) {
    var star = document.createElement('span')
    star.className = 'q-star';
    star.dataset.score = score;
    star.innerHTML = '☆'
    body.appendChild(star);
}

function appendQuestion(serial) {
    var q = document.createElement('div');
    q.className = 'q';
    q.dataset.serial = serial;
    q.dataset.chosen = 'n';

    var title = document.createElement('span');
    title.className = 'q-title';

    var brA = document.createElement('br');
    var brB = document.createElement('br');

    var subL = document.createElement('span')
    var subR = document.createElement('span')
    subL.className = 'q-sub l';
    subR.className = 'q-sub r';

    var stars = document.createElement('div');
    stars.className = 'q-stars';
    appendStar(stars, -3);
    appendStar(stars, -2);
    appendStar(stars, -1);
    appendStar(stars, 1);
    appendStar(stars, 2);
    appendStar(stars, 3);
    var brS = document.createElement('br');
    stars.appendChild(brS);
    appendStar(stars, 0);

    q.appendChild(title);
    q.appendChild(brA);
    q.appendChild(subL);
    q.appendChild(subR);
    q.appendChild(stars);
    q.appendChild(brB);

    var questionnaire = document.getElementById('questionnaire');
    questionnaire.appendChild(q);
}

function start() {
    for (var i = 0; i < prompts.length; i++) {
        appendQuestion(i);

    }

    var questions = document.getElementsByClassName('q');
    for (var i = 0; i < questions.length; i++) {
        var title = questions[i].getElementsByClassName('q-title')[0];
        var subL = questions[i].getElementsByClassName('q-sub l')[0];
        var subR = questions[i].getElementsByClassName('q-sub r')[0];
        title.textContent = 'Q.' + (i + 1).toString() + ' ' + prompts[prompt_order[i]];
        subL.textContent = options[prompt_order[i] * 2 + prompt_offset[i]];
        subR.textContent = options[prompt_order[i] * 2 + (1 - prompt_offset[i])];
    }

    var stars = document.getElementsByClassName('q-star');
    for (var i = 0; i < stars.length; i++) {
        stars[i].addEventListener('click', selectStar, false);
    }

    var instr = document.getElementById('instr');
    var btn = document.getElementById('instr-btn');

    // btn.parentNode.removeChild(btn); // kills element
    instr.style.visibility = 'hidden'; // hides element
    btn.style.display = 'none'; // hides element

    var questionnaire = document.getElementById('questionnaire')
    questionnaire.style.visibility = 'visible';
}

function checkSubmit() {
    if (answers != prompts.length) {
        return 0;
    }

    var questions = document.getElementsByClassName('q');
    for (var i = 0; i < questions.length; i++) {
        if (questions[i].dataset.chosen != 0) {
            var left_result = results[prompt_order[i] * 2 + prompt_offset[i]];
            var result_factor = 1;
            if ('XTMS'.includes(left_result)) {
                result_factor = -1;
            }

            if (Math.abs(questions[i].dataset.chosen) === 3) {
                var score = 2 * Math.sign(questions[i].dataset.chosen) * result_factor;
            } else {
                var score = Math.sign(questions[i].dataset.chosen) * result_factor;
            }

            if ('XN'.includes(left_result)) {
                XN_scores.push(score);
            } else if ('TB'.includes(left_result)) {
                TB_scores.push(score);
            } else if ('MR'.includes(left_result)) {
                MR_scores.push(score);
            } else if ('SC'.includes(left_result)) {
                SC_scores.push(score);
            }
        }
    }

    var questionnaire = document.getElementById('questionnaire');
    questionnaire.style.display = 'none';
    var result = document.getElementById('result');
    result.style.visibility = 'visible';

    displayResult();
}

// source: https://www.math.ucla.edu/~tom/distributions/tDist.html

function LogGamma(Z) {
    with (Math) {
        var S = 1 + 76.18009173 / Z - 86.50532033 / (Z + 1) + 24.01409822 / (Z + 2) - 1.231739516 / (Z + 3) + .00120858003 / (Z + 4) - .00000536382 / (Z + 5);
        var LG = (Z - .5) * log(Z + 4.5) - (Z + 4.5) + log(S * 2.50662827465);
    }
    return LG
}

// source: https://www.math.ucla.edu/~tom/distributions/tDist.html

function Betinc(X, A, B) {
    var A0 = 0;
    var B0 = 1;
    var A1 = 1;
    var B1 = 1;
    var M9 = 0;
    var A2 = 0;
    var C9;
    while (Math.abs((A1 - A2) / A1) > .00001) {
        A2 = A1;
        C9 = -(A + M9) * (A + B + M9) * X / (A + 2 * M9) / (A + 2 * M9 + 1);
        A0 = A1 + C9 * A0;
        B0 = B1 + C9 * B0;
        M9 = M9 + 1;
        C9 = M9 * (B - M9) * X / (A + 2 * M9 - 1) / (A + 2 * M9);
        A1 = A0 + C9 * A1;
        B1 = B0 + C9 * B1;
        A0 = A0 / B1;
        B0 = B0 / B1;
        A1 = A1 / B1;
        B1 = 1;
    }
    return A1 / A
}

// source: https://www.math.ucla.edu/~tom/distributions/tDist.html

function tCDF(X, df) {
    with (Math) {
        if (df <= 0) {
            alert("Degrees of freedom must be positive")
        } else {
            A = df / 2;
            S = A + .5;
            Z = df / (df + X * X);
            BT = exp(LogGamma(S) - LogGamma(.5) - LogGamma(A) + A * log(Z) + .5 * log(1 - Z));
            if (Z < (A + 1) / (S + 2)) {
                betacdf = BT * Betinc(Z, A, .5)
            } else {
                betacdf = 1 - BT * Betinc(1 - Z, .5, A)
            }
            if (X < 0) {
                tcdf = betacdf / 2
            } else {
                tcdf = 1 - betacdf / 2
            }
        }
        tcdf = round(tcdf * 100000) / 100000;
    }
    return tcdf
}

function arr_mean(arr) {
    if (arr.length === 0) {
        return 0;
    }

    var sum = 0;
    for (var i = 0; i < arr.length; i++) {
        sum += arr[i];
    }
    var mean = sum / arr.length;
    return mean;
}

function tTest(arr) {
    if (arr.length === 0) {
        return 0;
    }

    var n = arr.length;
    var mean = arr_mean(arr);
    var diff2_sum = 0;
    for (var i = 0; i < n; i++) {
        diff2_sum += (mean - arr[i]) ** 2;
    }
    var s = (diff2_sum / (n - 1)) ** 0.5;
    var t = (Math.abs(mean)) / (s / n ** 0.5);
    return tCDF(t, n - 1);
}

function getResult() {
    XN_mean = arr_mean(XN_scores);
    TB_mean = arr_mean(TB_scores);
    MR_mean = arr_mean(MR_scores);
    SC_mean = arr_mean(SC_scores);
    XN_prob = tTest(XN_scores);
    TB_prob = tTest(TB_scores);
    MR_prob = tTest(MR_scores);
    SC_prob = tTest(SC_scores);

    var NBTI = '';
    var MBTI = '';

    if (XN_prob >= significant && XN_mean > 0) {
        NBTI += 'X';
        MBTI += 'E';
    } else if (XN_prob >= significant && XN_mean < 0) {
        NBTI += 'N';
        MBTI += 'I';
    } else {
        NBTI += 'O';
        MBTI += 'X';
    }

    if (TB_prob >= significant && TB_mean > 0) {
        NBTI += 'T';
        MBTI += 'N';
    } else if (TB_prob >= significant && TB_mean < 0) {
        NBTI += 'B';
        MBTI += 'S';
    } else {
        NBTI += 'O';
        MBTI += 'X';
    }

    if (MR_prob >= significant && MR_mean > 0) {
        NBTI += 'M';
        MBTI += 'F';
    } else if (MR_prob >= significant && MR_mean < 0) {
        NBTI += 'R';
        MBTI += 'T';
    } else {
        NBTI += 'O';
        MBTI += 'X';
    }

    if (SC_prob >= significant && SC_mean > 0) {
        NBTI += 'S';
        MBTI += 'P';
    } else if (SC_prob >= significant && SC_mean < 0) {
        NBTI += 'C';
        MBTI += 'J';
    } else {
        NBTI += 'O';
        MBTI += 'X';
    }

    var NBTI_prob = -1;

    if (!NBTI.includes('O')) {
        NBTI_prob = XN_prob * TB_prob * MR_prob * SC_prob;
    }

    return [NBTI, NBTI_prob, MBTI];
}

function displayResult() {
    results = getResult();

    var title = document.getElementsByClassName('result-title')[0];
    title.innerHTML = title.innerHTML + '<B>' + results[0] + '</B>'

    if (results[1] != -1) {
        var prob = document.getElementById('result-prob-text');
        prob.innerHTML = '(With confidence of ' + ((Math.round(results[1] * 100) / 100).toFixed(2) * 100).toString() + '%)'
    }

    var equ = document.getElementById('result-equ-text');
    equ.innerHTML = 'The MBTI equivalent is ' + results[2];
}